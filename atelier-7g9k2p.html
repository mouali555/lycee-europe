<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Vault // Atelier</title>

  <!-- IMPORTANT: une page "secr√®te" ne doit pas compter sur l'obscurit√©.
       Le vrai verrouillage doit √™tre serveur / Firebase rules / backend. -->
  <meta name="robots" content="noindex,nofollow" />
  <meta name="description" content="Espace priv√© (Vault) ‚Äî acc√®s restreint." />
  <meta name="theme-color" content="#0b0f19" />

  <!-- Petite CSP (√† ajuster si tu charges Firebase depuis CDN etc.) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          img-src 'self' data:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline';
          connect-src 'self';
          base-uri 'none';
          form-action 'self';
          frame-ancestors 'none';
        " />

  <link rel="icon" href="./assets/img/favicon.svg" type="image/svg+xml" />

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B0F19;
      --card:#0f1627;
      --card2:#0c1220;
      --text:#e7ecff;
      --muted:#9aa8d0;
      --soft:#1a2542;
      --soft2:#101a32;
      --border:#223058;
      --accent:#7c5cff;
      --accent2:#31d2ff;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 60px rgba(0,0,0,.40);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    * { box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.20), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(49,210,255,.12), transparent 60%),
        radial-gradient(800px 600px at 60% 120%, rgba(124,92,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 50%, #050812);
      overflow-x:hidden;
    }

    a{ color:inherit; }
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 28px 18px 64px;
    }

    /* Top header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 14px 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 220px;
    }
    .logo{
      width: 40px; height:40px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 20% 20%, rgba(49,210,255,.35), transparent 52%),
        radial-gradient(circle at 80% 70%, rgba(124,92,255,.45), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:-30%;
      background: conic-gradient(from 90deg, rgba(49,210,255,.0), rgba(49,210,255,.25), rgba(124,92,255,.15), rgba(49,210,255,.0));
      animation: spin 6s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .brand h1{
      margin:0;
      font-size: 14px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(231,236,255,.92);
    }
    .brand p{
      margin:2px 0 0;
      font-size:12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      padding: 8px 10px;
      border-radius: 999px;
      color: rgba(231,236,255,.90);
      font-size: 12px;
      font-family: var(--mono);
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius: 99px;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(245,158,11,.14);
    }
    .dot.good{
      background: var(--good);
      box-shadow: 0 0 0 3px rgba(34,197,94,.14);
    }
    .dot.bad{
      background: var(--bad);
      box-shadow: 0 0 0 3px rgba(239,68,68,.14);
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      letter-spacing: .02em;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.04); border-color: rgba(124,92,255,.35); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(180deg, rgba(124,92,255,.18), rgba(124,92,255,.08));
    }
    .btn.danger{
      border-color: rgba(239,68,68,.55);
      background: linear-gradient(180deg, rgba(239,68,68,.14), rgba(239,68,68,.06));
    }

    /* Layout blocks */
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: auto; }
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card.soft{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: rgba(231,236,255,.88);
    }
    .muted{ color: var(--muted); }
    .mono{ font-family: var(--mono); }

    .separator{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(124,92,255,.55), rgba(49,210,255,.45), transparent);
      opacity:.45;
      margin: 12px 0;
    }

    /* Terminal */
    .terminal{
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(10,14,26,.85), rgba(7,10,18,.85));
      overflow:hidden;
    }
    .termTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      gap: 10px;
    }
    .termLights{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .light{
      width:10px; height:10px; border-radius: 99px;
      background: rgba(255,255,255,.14);
    }
    .termTitle{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(231,236,255,.78);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .termBody{
      padding: 12px;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.55;
      color: rgba(231,236,255,.90);
      max-height: 340px;
      overflow:auto;
    }
    .line{ opacity:.92; }
    .line.dim{ opacity:.65; }
    .line.good{ color: rgba(34,197,94,.95); }
    .line.bad{ color: rgba(239,68,68,.95); }
    .caret{
      display:inline-block;
      width: 8px;
      height: 16px;
      background: rgba(231,236,255,.75);
      margin-left: 6px;
      animation: blink 1s steps(1,end) infinite;
      vertical-align: -3px;
    }
    @keyframes blink{ 50%{ opacity:0; } }

    .inputRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items:center;
    }
    .input{
      flex:1;
      min-width: 220px;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      font-family: var(--mono);
    }
    .input:focus{ border-color: rgba(49,210,255,.55); box-shadow: 0 0 0 4px rgba(49,210,255,.10); }

    /* Small list */
    .list{
      display:grid;
      gap: 10px;
    }
    .item{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 12px;
    }
    .tag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 12px;
      font-family: var(--mono);
      color: rgba(231,236,255,.80);
      background: rgba(255,255,255,.02);
    }

    /* Hidden sections */
    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    .tiny{
      font-size: 12px;
      opacity: .82;
    }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Vault / Atelier</h1>
          <p id="buildTag">build: v3.0 ‚Ä¢ mode: LOCKED</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill" title="√âtat de session">
          <span id="sessionDot" class="dot"></span>
          <span id="sessionText">invit√©</span>
        </span>
        <button id="btnLogin" class="btn primary" type="button">Connexion</button>
        <button id="btnLogout" class="btn" type="button" style="display:none;">D√©connexion</button>
        <button id="btnPanic" class="btn danger" type="button" title="Ferme tout / reset local">PANIC</button>
      </div>
    </header>

    <!-- VIEW: Locked -->
    <section class="grid" style="margin-top:16px;">
      <div class="card" data-view="locked">
        <h2>Acc√®s restreint</h2>
        <p class="muted">
          Ce vault r√©pond uniquement si tu es <span class="mono">auth</span> + <span class="mono">membre</span>.
          Sinon, il te sert une page qui ressemble √† un bug cosmique mais qui est parfaitement volontaire.
        </p>

        <div class="separator"></div>

        <div class="terminal" aria-label="Console du vault">
          <div class="termTop">
            <div class="termLights" aria-hidden="true">
              <div class="light"></div><div class="light"></div><div class="light"></div>
            </div>
            <div class="termTitle" id="termTitle">vault://boot</div>
          </div>
          <div class="termBody" id="termBody"></div>
        </div>

        <div class="inputRow">
          <input id="inviteInput" class="input" placeholder="Code d‚Äôinvite (optionnel)" autocomplete="off" />
          <button id="btnJoin" class="btn primary" type="button">Rejoindre</button>
        </div>

        <p id="gateMsg" class="tiny muted" style="margin-top:10px;">‚Äî</p>
        <p class="tiny muted" style="margin-top:8px;">
          Astuce: tape <span class="kbd">/help</span> dans la console ci-dessous une fois connect√©.
        </p>
      </div>

      <aside class="card soft" data-view="locked">
        <h2>R√®gles du jeu</h2>
        <div class="list">
          <div class="item">
            <div class="tag">üîê S√©curit√©</div>
            <p class="tiny muted" style="margin:10px 0 0;">
              Le secret n‚Äôest pas dans l‚ÄôURL. Il est dans les r√®gles (Firestore/Backend) + contr√¥le d‚Äôacc√®s r√©el.
            </p>
          </div>
          <div class="item">
            <div class="tag">üß™ Lore</div>
            <p class="tiny muted" style="margin:10px 0 0;">
              Ici, les logs mentent parfois‚Ä¶ mais uniquement pour les gens non membres.
            </p>
          </div>
          <div class="item">
            <div class="tag">üßØ PANIC</div>
            <p class="tiny muted" style="margin:10px 0 0;">
              Le bouton PANIC efface le stockage local, coupe l‚ÄôUI, et repasse en mode ‚Äúcoffre ferm√©‚Äù.
            </p>
          </div>
        </div>
      </aside>
    </section>

    <!-- VIEW: Unlocked -->
    <section class="grid" data-view="unlocked" style="margin-top:16px;">
      <div class="card">
        <h2>Bienvenue, membre</h2>
        <p class="muted">
          Tu es entr√© dans le vault. Ici tu as :
          <span class="mono">mini-chat</span>, <span class="mono">ops panel</span>, et un <span class="mono">terminal</span> qui accepte des commandes.
        </p>

        <div class="separator"></div>

        <div class="terminal" aria-label="Terminal priv√©">
          <div class="termTop">
            <div class="termLights" aria-hidden="true">
              <div class="light"></div><div class="light"></div><div class="light"></div>
            </div>
            <div class="termTitle">vault://terminal ‚Ä¢ room=atelier</div>
          </div>
          <div class="termBody" id="privateTerm"></div>
        </div>

        <div class="inputRow">
          <input id="cmdInput" class="input" placeholder="Commande‚Ä¶ ex: /status, /motd, /lore, /clear" autocomplete="off" />
          <button id="btnRun" class="btn primary" type="button">Ex√©cuter</button>
        </div>

        <p class="tiny muted" style="margin-top:10px;">
          Commandes rapides: <span class="kbd">/help</span> <span class="kbd">/status</span> <span class="kbd">/lore</span> <span class="kbd">/whoami</span> <span class="kbd">/clear</span>
        </p>
      </div>

      <aside class="card">
        <h2>Mini-chat</h2>
        <p class="tiny muted" style="margin:0 0 10px;">
          Hook pr√™t pour Firestore. (Tu branches tes r√®gles + ta config c√¥t√© JS.)
        </p>

        <div class="terminal" style="margin-bottom:10px;">
          <div class="termTop">
            <div class="termTitle">vault://chat</div>
          </div>
          <div class="termBody" id="chatList" style="max-height:240px;"></div>
        </div>

        <div class="inputRow">
          <input id="chatInput" class="input" placeholder="Message‚Ä¶" autocomplete="off" />
          <button id="btnSend" class="btn primary" type="button">Envoyer</button>
        </div>

        <p class="tiny muted" style="margin-top:10px;">
          Bonus: <span class="mono">Shift+Enter</span> pour ins√©rer une nouvelle ligne (si tu veux).
        </p>
      </aside>
    </section>

    <!-- VIEW: Not Found (fake 404) -->
    <section class="grid" data-view="ghost" style="margin-top:16px;">
      <div class="card">
        <h2>404</h2>
        <p class="muted">
          Cette page n‚Äôexiste probablement pas.
          Ou alors elle s‚Äôest convertie en viennoiserie quantique.
        </p>
        <div class="separator"></div>
        <button class="btn" type="button" onclick="location.href='./index.html'">Retour √† l‚Äôaccueil</button>
      </div>

      <aside class="card soft">
        <h2>Indice</h2>
        <p class="tiny muted" style="margin:0;">
          Si tu es cens√© √™tre ici, connecte-toi. Sinon‚Ä¶ tu as trouv√© une porte peinte sur un mur.
        </p>
      </aside>
    </section>

  </div>

  <script>
    /**********************************************************************
     * VAULT ‚Äî Single Page
     * Objectif: UI clean + hooks pour ton vrai syst√®me (Firebase/Auth/Rules)
     * Note: ce fichier est volontairement autonome.
     **********************************************************************/

    // ---------------------------
    // Helpers
    // ---------------------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const now = () => new Date().toISOString().replace('T',' ').replace('Z',' UTC');
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    const state = {
      isAuthed: false,
      isMember: false,
      user: null,      // { uid, email, displayName }
      room: "atelier",
      motd: "Les pingouins signent les commits uniquement le jeudi.",
      booted: false,
      chat: []         // local demo; √† remplacer par Firestore
    };

    const storage = {
      get(k, fallback=null){
        try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : fallback; }
        catch{ return fallback; }
      },
      set(k, v){
        try{ localStorage.setItem(k, JSON.stringify(v)); } catch {}
      },
      del(k){
        try{ localStorage.removeItem(k); } catch {}
      },
      wipe(){
        try{ localStorage.clear(); } catch {}
      }
    };

    // ---------------------------
    // Views
    // ---------------------------
    function showView(name){
      document.querySelectorAll("[data-view]").forEach(el => el.classList.remove("show"));
      document.querySelectorAll(`[data-view="${name}"]`).forEach(el => el.classList.add("show"));
    }

    function setSessionBadge(mode){
      const dot = $("#sessionDot");
      const txt = $("#sessionText");
      const buildTag = $("#buildTag");

      if(mode === "LOCKED"){
        dot.className = "dot";
        txt.textContent = "invit√©";
        buildTag.textContent = "build: v3.0 ‚Ä¢ mode: LOCKED";
      }
      if(mode === "AUTH"){
        dot.className = "dot good";
        txt.textContent = "auth";
        buildTag.textContent = "build: v3.0 ‚Ä¢ mode: AUTH";
      }
      if(mode === "MEMBER"){
        dot.className = "dot good";
        txt.textContent = "membre";
        buildTag.textContent = "build: v3.0 ‚Ä¢ mode: MEMBER";
      }
      if(mode === "GHOST"){
        dot.className = "dot bad";
        txt.textContent = "??";
        buildTag.textContent = "build: v3.0 ‚Ä¢ mode: GHOST";
      }
    }

    // ---------------------------
    // Terminal rendering
    // ---------------------------
    function termPush(el, text, cls="line"){
      const div = document.createElement("div");
      div.className = cls;
      div.textContent = text;
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
    }

    function termBanner(el){
      termPush(el, "VAULT BOOT SEQUENCE", "line");
      termPush(el, "------------------", "line dim");
      termPush(el, `[${now()}] init: ok`, "line dim");
      termPush(el, `[${now()}] gate: waiting for auth`, "line dim");
      termPush(el, "tip: connecte-toi pour continuer.", "line dim");
      const caret = document.createElement("span");
      caret.className = "caret";
      el.appendChild(caret);
      el.scrollTop = el.scrollHeight;
    }

    function termClear(el){
      el.innerHTML = "";
    }

    // ---------------------------
    // Demo ‚ÄúAuth / Membership‚Äù
    // (√Ä remplacer par Firebase Auth + Firestore membership check.)
    // ---------------------------
    async function fakeLogin(){
      // Ici tu branches Google login.
      // Pour la d√©mo: on simule une session.
      await sleep(250);
      state.isAuthed = true;
      state.user = {
        uid: "demo_" + Math.random().toString(16).slice(2),
        email: "membre@atelier.local",
        displayName: "Membre D√©mo"
      };
      // Membership: on regarde localStorage (d√©mo)
      state.isMember = storage.get("vault_member", false) === true;
    }

    async function fakeLogout(){
      await sleep(120);
      state.isAuthed = false;
      state.isMember = false;
      state.user = null;
    }

    async function fakeJoin(inviteCode){
      await sleep(200);
      // Tu peux remplacer par un appel Cloud Function / Firestore validation.
      // D√©mo: un code simple, mais √©videmment en vrai √ßa ne doit PAS √™tre c√¥t√© client.
      const ok = (inviteCode || "").trim().toLowerCase() === "atelier";
      if(ok){
        storage.set("vault_member", true);
        state.isMember = true;
        return { ok:true, msg:"Membre ajout√©. (d√©mo localStorage)" };
      }
      return { ok:false, msg:"Code invalide. (Indice: essaye 'atelier')" };
    }

    // ---------------------------
    // Gate logic
    // ---------------------------
    function refreshUI(){
      const btnLogin = $("#btnLogin");
      const btnLogout = $("#btnLogout");

      if(!state.isAuthed){
        setSessionBadge("LOCKED");
        btnLogin.style.display = "";
        btnLogout.style.display = "none";
        showView("locked");
        return;
      }

      // Auth ok, pas membre
      if(state.isAuthed && !state.isMember){
        setSessionBadge("AUTH");
        btnLogin.style.display = "none";
        btnLogout.style.display = "";
        showView("locked");
        $("#gateMsg").textContent = `Connect√©: ${state.user.displayName} ‚Ä¢ pas membre ‚Ä¢ tu peux entrer un code d'invite.`;
        return;
      }

      // Membre
      setSessionBadge("MEMBER");
      btnLogin.style.display = "none";
      btnLogout.style.display = "";
      showView("unlocked");
    }

    // ---------------------------
    // Private terminal commands
    // ---------------------------
    function cmdHelp(){
      return [
        "Commandes disponibles:",
        "  /help         -> aide",
        "  /status       -> √©tat du vault",
        "  /whoami       -> identit√©",
        "  /motd         -> message du jour",
        "  /lore         -> lore absurde",
        "  /clear        -> clear terminal",
        "  /panic        -> reset local + logout"
      ];
    }

    function cmdLore(){
      const lore = [
        "Le mardi a √©t√© supprim√© par un clic droit.",
        "Le Wi-Fi s‚Äôappelle 'painternet' depuis l‚Äôincident de la baguette-modem.",
        "Un hamster a valid√© la prod. Le hamster exige du respect.",
        "Les erreurs 404 sont des portails qui ont peur.",
        "La doc a √©t√© √©crite par une imprimante en pleine crise existentielle."
      ];
      const pick = lore[Math.floor(Math.random()*lore.length)];
      return [`Lore: ${pick}`];
    }

    function cmdStatus(){
      return [
        `room: ${state.room}`,
        `auth: ${state.isAuthed ? "yes" : "no"}`,
        `member: ${state.isMember ? "yes" : "no"}`,
        `time: ${now()}`
      ];
    }

    function cmdWhoami(){
      if(!state.user) return ["whoami: unknown"];
      return [
        `uid: ${state.user.uid}`,
        `email: ${state.user.email}`,
        `name: ${state.user.displayName}`
      ];
    }

    function runCommand(raw){
      const s = (raw || "").trim();
      if(!s) return { action:"noop", lines:[] };

      if(s === "/clear") return { action:"clear", lines:[] };
      if(s === "/panic") return { action:"panic", lines:["PANIC: effacement local + fermeture du vault‚Ä¶"] };
      if(s === "/help")  return { action:"print", lines: cmdHelp() };
      if(s === "/status")return { action:"print", lines: cmdStatus() };
      if(s === "/whoami")return { action:"print", lines: cmdWhoami() };
      if(s === "/motd")  return { action:"print", lines:[`motd: ${state.motd}`] };
      if(s === "/lore")  return { action:"print", lines: cmdLore() };

      // fallback
      return { action:"print", lines:[`Commande inconnue: ${s}`, "Tape /help"] };
    }

    // ---------------------------
    // Chat (d√©mo local)
    // ---------------------------
    function renderChat(){
      const list = $("#chatList");
      list.innerHTML = "";
      if(state.chat.length === 0){
        termPush(list, "Aucun message. (d√©mo locale)", "line dim");
        return;
      }
      for(const m of state.chat.slice(-80)){
        termPush(list, `[${m.t}] ${m.name}: ${m.text}`, "line");
      }
    }

    function chatSend(text){
      const msg = (text || "").trim();
      if(!msg) return;
      const name = state.user?.displayName || "anon";
      state.chat.push({ t: new Date().toLocaleTimeString(), name, text: msg });
      storage.set("vault_chat_demo", state.chat);
      renderChat();
    }

    // ---------------------------
    // Boot
    // ---------------------------
    async function boot(){
      if(state.booted) return;
      state.booted = true;

      // Restore demo chat
      state.chat = storage.get("vault_chat_demo", []);
      renderChat();

      // Locked terminal banner
      const term = $("#termBody");
      termClear(term);
      termBanner(term);

      refreshUI();
    }

    // ---------------------------
    // Wire events
    // ---------------------------
    $("#btnLogin").addEventListener("click", async () => {
      $("#gateMsg").textContent = "Connexion‚Ä¶";
      await fakeLogin();
      refreshUI();

      // extra logs
      const term = $("#termBody");
      termClear(term);
      termPush(term, `[${now()}] auth: ok`, "line good");
      termPush(term, `[${now()}] membership: ${state.isMember ? "ok" : "missing"}`, state.isMember ? "line good" : "line bad");
      termPush(term, "Si membership=missing, utilise le code d‚Äôinvite.", "line dim");
    });

    $("#btnLogout").addEventListener("click", async () => {
      await fakeLogout();
      $("#gateMsg").textContent = "D√©connect√©.";
      boot(); // redraw locked banner
      refreshUI();
    });

    $("#btnJoin").addEventListener("click", async () => {
      if(!state.isAuthed){
        $("#gateMsg").textContent = "Connecte-toi d‚Äôabord.";
        return;
      }
      const code = $("#inviteInput").value;
      $("#gateMsg").textContent = "V√©rification du code‚Ä¶";
      const res = await fakeJoin(code);
      $("#gateMsg").textContent = res.msg;
      refreshUI();
    });

    $("#btnPanic").addEventListener("click", async () => {
      // PANIC: wipe local + logout + UI locked
      storage.wipe();
      state.chat = [];
      await fakeLogout();
      setSessionBadge("LOCKED");
      showView("locked");
      $("#gateMsg").textContent = "PANIC: localStorage effac√©. Vault referm√©.";
      boot();
    });

    // Private terminal
    $("#btnRun").addEventListener("click", () => {
      const input = $("#cmdInput");
      const cmd = input.value;
      input.value = "";

      const term = $("#privateTerm");
      termPush(term, `> ${cmd}`, "line dim");

      const out = runCommand(cmd);
      if(out.action === "clear"){
        termClear(term);
        return;
      }
      if(out.action === "panic"){
        out.lines.forEach(l => termPush(term, l, "line bad"));
        $("#btnPanic").click();
        return;
      }
      out.lines.forEach(l => termPush(term, l, "line"));
    });

    $("#cmdInput").addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        $("#btnRun").click();
      }
    });

    // Chat
    $("#btnSend").addEventListener("click", () => {
      chatSend($("#chatInput").value);
      $("#chatInput").value = "";
    });

    $("#chatInput").addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        $("#btnSend").click();
      }
    });

    // Start
    boot();
  </script>
</body>
</html>
